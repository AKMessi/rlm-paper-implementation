<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RLM - Recursive Language Model</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #ec4899;
            --background: #0f172a;
            --surface: #1e293b;
            --surface-light: #334155;
            --text: #f8fafc;
            --text-muted: #94a3b8;
            --border: #475569;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(135deg, var(--surface) 0%, var(--surface-light) 100%);
            border-radius: 16px;
            margin-bottom: 30px;
            border: 1px solid var(--border);
        }

        header h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        header p {
            color: var(--text-muted);
            font-size: 1.1rem;
        }

        .badge {
            display: inline-block;
            background: var(--success);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 10px;
        }

        .badge.warning {
            background: var(--warning);
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 900px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--surface);
            border-radius: 12px;
            padding: 24px;
            border: 1px solid var(--border);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .card h2 {
            font-size: 1.25rem;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card h2 .icon {
            width: 24px;
            height: 24px;
            background: var(--primary);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .byok-banner {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(34, 197, 94, 0.05) 100%);
            border: 1px solid var(--success);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .byok-banner h3 {
            color: var(--success);
            margin-bottom: 8px;
        }

        .byok-banner p {
            color: var(--text-muted);
            font-size: 0.95rem;
        }

        .api-key-section {
            background: var(--surface-light);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .api-key-section h3 {
            font-size: 1rem;
            margin-bottom: 16px;
            color: var(--primary);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            color: var(--text);
            font-size: 1rem;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .key-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 0.9rem;
        }

        .key-status.set {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .key-status.not-set {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--warning);
            color: var(--warning);
        }

        .drop-zone {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--surface-light);
        }

        .drop-zone:hover, .drop-zone.dragover {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .drop-zone .icon-large {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .drop-zone p {
            color: var(--text-muted);
        }

        .drop-zone .file-types {
            font-size: 0.85rem;
            margin-top: 8px;
        }

        input[type="file"] {
            display: none;
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            justify-content: center;
        }

        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .btn:disabled {
            background: var(--surface-light);
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: var(--surface-light);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-success {
            background: var(--success);
        }

        .btn-success:hover {
            background: #16a34a;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.875rem;
            width: auto;
        }

        .file-list {
            margin-top: 20px;
        }

        .file-item {
            background: var(--surface-light);
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .file-item .name {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .file-item .remove {
            background: none;
            border: none;
            color: var(--error);
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .file-item .remove:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        .query-section {
            margin-top: 20px;
        }

        textarea {
            width: 100%;
            background: var(--background);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            color: var(--text);
            font-size: 1rem;
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .options {
            display: flex;
            gap: 20px;
            margin: 16px 0;
            flex-wrap: wrap;
        }

        .option {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-muted);
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
        }

        .results {
            background: var(--surface);
            border-radius: 12px;
            padding: 24px;
            margin-top: 20px;
            border: 1px solid var(--border);
        }

        .results h3 {
            margin-bottom: 16px;
            color: var(--primary);
        }

        .answer {
            background: var(--background);
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
            line-height: 1.8;
            white-space: pre-wrap;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .stat {
            background: var(--surface-light);
            padding: 12px 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat .value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary);
        }

        .stat .label {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            gap: 12px;
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
        }

        .success {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
        }

        .session-info {
            background: var(--surface-light);
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
        }

        .session-id {
            font-family: monospace;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .how-it-works {
            margin-top: 30px;
            padding: 30px;
            background: linear-gradient(135deg, var(--surface) 0%, var(--surface-light) 100%);
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .how-it-works h2 {
            margin-bottom: 20px;
            color: var(--primary);
        }

        .steps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .step {
            background: var(--background);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .step .number {
            width: 32px;
            height: 32px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .step h4 {
            margin-bottom: 8px;
        }

        .step p {
            color: var(--text-muted);
            font-size: 0.95rem;
        }

        .hidden {
            display: none !important;
        }

        .cost-estimate {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid var(--primary);
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            font-size: 0.9rem;
        }

        .cost-estimate h4 {
            color: var(--primary);
            margin-bottom: 8px;
        }

        .cost-estimate ul {
            margin-left: 20px;
            color: var(--text-muted);
        }

        .cost-estimate li {
            margin-bottom: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Recursive Language Model</h1>
            <p>Process arbitrarily long documents using recursive LLM retrieval</p>
            <span class="badge">BYOK - Bring Your Own Key</span>
        </header>

        <div class="byok-banner">
            <h3>Zero Cost to Deployer</h3>
            <p>This app uses YOUR API keys. The deployer pays nothing. Your keys are stored only in memory and never saved to disk.</p>
        </div>

        <div class="session-info">
            <div>
                Session: <span class="session-id" id="sessionId">Creating...</span>
            </div>
            <button class="btn btn-secondary btn-small" onclick="resetSession()">New Session</button>
        </div>

        <div class="grid">
            <!-- API Keys Card -->
            <div class="card">
                <h2><span class="icon">[KEY]</span> API Configuration</h2>
                
                <div id="keyStatus" class="key-status not-set">
                    <span>‚ö†Ô∏è</span>
                    <span>No API keys set. Please add your keys below.</span>
                </div>

                <div class="api-key-section">
                    <h3>Select Provider</h3>
                    <div class="form-group">
                        <label>LLM Provider</label>
                        <select id="rootProvider" onchange="updateProviderFields()">
                            <option value="openai">OpenAI (GPT-4, GPT-4o)</option>
                            <option value="anthropic">Anthropic (Claude 3.5)</option>
                            <option value="groq">Groq (Fast Llama/Mixtral)</option>
                            <option value="together">Together AI (Open Source)</option>
                            <option value="google">Google (Gemini)</option>
                            <option value="mistral">Mistral AI</option>
                            <option value="cohere">Cohere</option>
                            <option value="deepseek">DeepSeek (Cheapest)</option>
                            <option value="azure">Azure OpenAI</option>
                            <option value="ollama">Ollama (Local - FREE)</option>
                            <option value="mock">Mock (Testing)</option>
                        </select>
                    </div>

                    <div class="form-group" id="apiKeyGroup">
                        <label>API Key <span id="keyHelp" style="font-size: 0.8rem; color: var(--text-muted);"></span></label>
                        <input type="password" id="apiKey" placeholder="Enter your API key">
                        <small id="keyUrl" style="font-size: 0.8rem; color: var(--text-muted);"></small>
                    </div>

                    <div class="form-group" id="baseUrlGroup" style="display: none;">
                        <label>Base URL (for Ollama)</label>
                        <input type="text" id="baseUrl" placeholder="http://localhost:11434" value="http://localhost:11434">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Root Model</label>
                            <select id="rootModel">
                                <option value="gpt-4o-mini" selected>GPT-4o Mini ($0.15/M)</option>
                                <option value="gpt-4o">GPT-4o ($2.50/M)</option>
                                <option value="gpt-4-turbo">GPT-4 Turbo ($10/M)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Sub Model</label>
                            <select id="subModel">
                                <option value="gpt-4o-mini" selected>GPT-4o Mini ($0.15/M)</option>
                                <option value="gpt-4o">GPT-4o ($2.50/M)</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Sub Provider</label>
                            <select id="subProvider">
                                <option value="same" selected>Same as Root</option>
                                <option value="groq">Groq (Fast & Cheap)</option>
                                <option value="together">Together AI</option>
                                <option value="deepseek">DeepSeek (Cheapest)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <button class="btn btn-success" onclick="saveApiKeys()">
                    Save API Keys
                </button>

                <div class="cost-estimate">
                    <h4>üí∞ Cost Estimates (per 1M tokens)</h4>
                    <ul>
                        <li><strong>DeepSeek:</strong> $0.07-0.30 (Cheapest!)</li>
                        <li><strong>Groq:</strong> $0.20-0.60 (Very Fast)</li>
                        <li><strong>OpenAI 4o-mini:</strong> $0.15-0.60</li>
                        <li><strong>Gemini Flash:</strong> $0.08-0.30</li>
                        <li><strong>Claude 3.5:</strong> $3-15 (Best Quality)</li>
                        <li><strong>Ollama:</strong> FREE (Runs Locally)</li>
                        <li><strong>Typical document:</strong> $0.05 - $0.50</li>
                    </ul>
                </div>

                <div class="cost-estimate" style="background: rgba(99, 102, 241, 0.1); border-color: var(--primary);">
                    <h4>‚≠ê Recommendations</h4>
                    <ul>
                        <li><strong>Cheapest:</strong> DeepSeek or Groq</li>
                        <li><strong>Best Quality:</strong> GPT-4o or Claude 3.5</li>
                        <li><strong>Fastest:</strong> Groq (Llama 3.1)</li>
                        <li><strong>Free:</strong> Ollama (run locally)</li>
                    </ul>
                </div>
            </div>

            <!-- Documents Card -->
            <div class="card">
                <h2><span class="icon">[DOC]</span> Upload Documents</h2>
                
                <div class="drop-zone" id="dropZone">
                    <div class="icon-large">[UPLOAD]</div>
                    <p>Drag & drop files here or click to browse</p>
                    <div class="file-types">Supports: PDF, TXT, DOCX, MD, JSON, Code files (Max 100MB)</div>
                    <input type="file" id="fileInput" multiple accept=".pdf,.txt,.docx,.md,.markdown,.json,.py,.js,.java,.cpp,.c,.h,.ts,.tsx,.jsx">
                </div>

                <div class="file-list" id="fileList"></div>
            </div>

            <!-- Query Card -->
            <div class="card" style="grid-column: 1 / -1;">
                <h2><span class="icon">[Q]</span> Ask Questions</h2>
                
                <div class="query-section">
                    <textarea id="queryInput" placeholder="Enter your question about the uploaded documents...&#10;&#10;Example: 'What are the main points discussed in the document?'&#10;&#10;The RLM will recursively search through the documents to find answers."></textarea>
                    
                    <div class="options">
                        <label class="option">
                            <input type="checkbox" id="useSubcalls" checked>
                            <span>Use recursive sub-calls (RLM)</span>
                        </label>
                        <label class="option">
                            <input type="number" id="maxIterations" value="50" min="10" max="100" style="width: 60px; background: var(--background); border: 1px solid var(--border); border-radius: 4px; padding: 4px; color: var(--text);">
                            <span>Max iterations</span>
                        </label>
                    </div>

                    <button class="btn" id="queryBtn" onclick="submitQuery()" disabled>
                        <span>[SEARCH]</span> Query with RLM
                    </button>
                </div>
            </div>
        </div>

        <div id="results" class="results hidden">
            <h3>Results</h3>
            <div id="resultsContent"></div>
        </div>

        <div class="how-it-works">
            <h2>How RLM Works</h2>
            <div class="steps">
                <div class="step">
                    <div class="number">1</div>
                    <h4>Set Your API Key</h4>
                    <p>Add your OpenAI API key. You only pay for what you use. No subscriptions.</p>
                </div>
                <div class="step">
                    <div class="number">2</div>
                    <h4>Upload Documents</h4>
                    <p>Upload documents of any size. The system automatically chunks them for processing.</p>
                </div>
                <div class="step">
                    <div class="number">3</div>
                    <h4>REPL Environment</h4>
                    <p>Documents are loaded into a REPL as variables. The LLM can programmatically examine them.</p>
                </div>
                <div class="step">
                    <div class="number">4</div>
                    <h4>Recursive Calls</h4>
                    <p>The root LLM calls sub-LLMs on chunks, aggregating results for efficient retrieval.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Session management
        let sessionId = null;
        let uploadedFiles = [];
        let apiKeysSet = false;
        const API_URL = '';  // Same origin

        // Initialize
        async function initSession() {
            sessionId = localStorage.getItem('rlm_session_id');
            if (sessionId) {
                try {
                    const response = await fetch(`${API_URL}/sessions/${sessionId}`);
                    if (response.ok) {
                        const data = await response.json();
                        document.getElementById('sessionId').textContent = sessionId.substring(0, 8) + '...';
                        uploadedFiles = data.documents || [];
                        updateFileList();
                        
                        // Check if API keys are set
                        checkApiKeys();
                        return;
                    }
                } catch (e) {
                    console.error('Failed to restore session:', e);
                }
            }
            createNewSession();
        }

        function createNewSession() {
            sessionId = generateUUID();
            localStorage.setItem('rlm_session_id', sessionId);
            document.getElementById('sessionId').textContent = sessionId.substring(0, 8) + '...';
            uploadedFiles = [];
            updateFileList();
            updateKeyStatus(false);
        }

        function resetSession() {
            localStorage.removeItem('rlm_session_id');
            createNewSession();
            document.getElementById('results').classList.add('hidden');
        }

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Provider configuration
        const PROVIDER_CONFIG = {
            openai: {
                keyPrefix: 'sk-',
                keyUrl: 'https://platform.openai.com/api-keys',
                models: [
                    {value: 'gpt-4o-mini', label: 'GPT-4o Mini ($0.15/M)', cost: '$0.15'},
                    {value: 'gpt-4o', label: 'GPT-4o ($2.50/M)', cost: '$2.50'},
                    {value: 'gpt-4-turbo', label: 'GPT-4 Turbo ($10/M)', cost: '$10'}
                ]
            },
            anthropic: {
                keyPrefix: 'sk-ant-',
                keyUrl: 'https://console.anthropic.com/',
                models: [
                    {value: 'claude-3-5-sonnet-20241022', label: 'Claude 3.5 Sonnet ($3-15/M)', cost: '$3-15'},
                    {value: 'claude-3-haiku-20240307', label: 'Claude 3 Haiku ($0.50/M)', cost: '$0.50'}
                ]
            },
            groq: {
                keyPrefix: 'gsk_',
                keyUrl: 'https://console.groq.com/keys',
                models: [
                    {value: 'llama-3.1-70b-versatile', label: 'Llama 3.1 70B ($0.59/M)', cost: '$0.59'},
                    {value: 'llama-3.1-8b-instant', label: 'Llama 3.1 8B ($0.05/M)', cost: '$0.05'},
                    {value: 'mixtral-8x7b-32768', label: 'Mixtral 8x7B ($0.24/M)', cost: '$0.24'}
                ]
            },
            together: {
                keyPrefix: '',
                keyUrl: 'https://api.together.xyz/',
                models: [
                    {value: 'meta-llama/Llama-3.1-70B-Instruct-Turbo', label: 'Llama 3.1 70B ($0.88/M)', cost: '$0.88'},
                    {value: 'meta-llama/Llama-3.1-8B-Instruct-Turbo', label: 'Llama 3.1 8B ($0.18/M)', cost: '$0.18'}
                ]
            },
            google: {
                keyPrefix: '',
                keyUrl: 'https://aistudio.google.com/app/apikey',
                models: [
                    {value: 'gemini-1.5-flash', label: 'Gemini 1.5 Flash ($0.08/M)', cost: '$0.08'},
                    {value: 'gemini-1.5-pro', label: 'Gemini 1.5 Pro ($3.50/M)', cost: '$3.50'}
                ]
            },
            mistral: {
                keyPrefix: '',
                keyUrl: 'https://console.mistral.ai/',
                models: [
                    {value: 'mistral-large-latest', label: 'Mistral Large ($4/M)', cost: '$4'},
                    {value: 'mistral-medium-latest', label: 'Mistral Medium ($2/M)', cost: '$2'},
                    {value: 'mistral-small-latest', label: 'Mistral Small ($0.20/M)', cost: '$0.20'}
                ]
            },
            cohere: {
                keyPrefix: '',
                keyUrl: 'https://dashboard.cohere.com/api-keys',
                models: [
                    {value: 'command-r-plus', label: 'Command R+ ($2.50/M)', cost: '$2.50'},
                    {value: 'command-r', label: 'Command R ($0.50/M)', cost: '$0.50'}
                ]
            },
            deepseek: {
                keyPrefix: 'sk-',
                keyUrl: 'https://platform.deepseek.com/',
                models: [
                    {value: 'deepseek-chat', label: 'DeepSeek Chat ($0.07/M)', cost: '$0.07'},
                    {value: 'deepseek-coder', label: 'DeepSeek Coder ($0.07/M)', cost: '$0.07'}
                ]
            },
            azure: {
                keyPrefix: '',
                keyUrl: 'https://portal.azure.com',
                models: [
                    {value: 'gpt-4o', label: 'GPT-4o (Azure)', cost: 'Varies'},
                    {value: 'gpt-4', label: 'GPT-4 (Azure)', cost: 'Varies'}
                ]
            },
            ollama: {
                keyPrefix: '',
                keyUrl: 'https://ollama.com/',
                models: [
                    {value: 'llama3.1', label: 'Llama 3.1 (Local)', cost: 'FREE'},
                    {value: 'mistral', label: 'Mistral (Local)', cost: 'FREE'},
                    {value: 'qwen2.5', label: 'Qwen 2.5 (Local)', cost: 'FREE'}
                ]
            },
            mock: {
                keyPrefix: '',
                keyUrl: '',
                models: [
                    {value: 'mock-model', label: 'Mock (Testing)', cost: 'FREE'}
                ]
            }
        };

        function updateProviderFields() {
            const provider = document.getElementById('rootProvider').value;
            const config = PROVIDER_CONFIG[provider];
            
            // Update key help text
            const keyHelp = document.getElementById('keyHelp');
            const keyUrl = document.getElementById('keyUrl');
            const apiKeyGroup = document.getElementById('apiKeyGroup');
            const baseUrlGroup = document.getElementById('baseUrlGroup');
            
            if (provider === 'ollama') {
                apiKeyGroup.style.display = 'none';
                baseUrlGroup.style.display = 'block';
                keyHelp.textContent = '';
                keyUrl.innerHTML = `Install Ollama: <a href="${config.keyUrl}" target="_blank" style="color: var(--primary);">${config.keyUrl}</a>`;
            } else if (provider === 'mock') {
                apiKeyGroup.style.display = 'none';
                baseUrlGroup.style.display = 'none';
                keyHelp.textContent = '';
                keyUrl.textContent = 'No API key needed for testing';
            } else {
                apiKeyGroup.style.display = 'block';
                baseUrlGroup.style.display = 'none';
                keyHelp.textContent = config.keyPrefix ? `(starts with ${config.keyPrefix})` : '';
                keyUrl.innerHTML = `Get key: <a href="${config.keyUrl}" target="_blank" style="color: var(--primary);">${config.keyUrl}</a>`;
            }
            
            // Update model dropdowns
            const rootModel = document.getElementById('rootModel');
            const subModel = document.getElementById('subModel');
            
            rootModel.innerHTML = config.models.map(m => 
                `<option value="${m.value}">${m.label}</option>`
            ).join('');
            
            subModel.innerHTML = config.models.map(m => 
                `<option value="${m.value}">${m.label}</option>`
            ).join('');
            
            // Select cheapest by default for sub-model
            subModel.selectedIndex = config.models.length - 1;
        }

        // API Key management
        async function saveApiKeys() {
            const provider = document.getElementById('rootProvider').value;
            const apiKey = document.getElementById('apiKey').value.trim();
            const rootModel = document.getElementById('rootModel').value;
            const subModel = document.getElementById('subModel').value;
            let subProvider = document.getElementById('subProvider').value;
            const baseUrl = document.getElementById('baseUrl').value;
            
            if (subProvider === 'same') {
                subProvider = provider;
            }

            const config = PROVIDER_CONFIG[provider];
            
            // Validate API key
            if (provider !== 'ollama' && provider !== 'mock') {
                if (!apiKey) {
                    alert(`Please enter your ${provider.toUpperCase()} API key`);
                    return;
                }
                if (config.keyPrefix && !apiKey.startsWith(config.keyPrefix)) {
                    alert(`Invalid API key format. Should start with "${config.keyPrefix}"`);
                    return;
                }
            }

            // Build request with proper API key field names
            const requestBody = {
                session_id: sessionId,
                root_provider: provider,
                sub_provider: subProvider,
                root_model: rootModel,
                sub_model: subModel
            };
            
            // Add provider-specific key with CORRECT field name
            const keyFieldMap = {
                'openai': 'openai_api_key',
                'anthropic': 'anthropic_api_key',
                'google': 'google_api_key',
                'gemini': 'google_api_key',
                'kimi': 'kimi_api_key',
                'moonshot': 'kimi_api_key',
                'groq': 'groq_api_key',
                'together': 'together_api_key',
                'mistral': 'mistral_api_key',
                'cohere': 'cohere_api_key',
                'deepseek': 'deepseek_api_key',
                'perplexity': 'perplexity_api_key',
                'azure': 'azure_api_key'
            };
            
            if (provider !== 'mock' && provider !== 'ollama') {
                const keyField = keyFieldMap[provider] || 'openai_api_key';
                requestBody[keyField] = apiKey;
            }

            try {
                const response = await fetch(`${API_URL}/api/keys`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                if (data.success) {
                    updateKeyStatus(true, data.keys_set);
                    alert('API keys saved successfully!');
                    // Clear the input for security
                    document.getElementById('apiKey').value = '';
                } else {
                    alert('Failed to save API keys: ' + (data.message || 'Unknown error'));
                }
            } catch (error) {
                alert('Error saving API keys: ' + error.message);
            }
        }

        async function checkApiKeys() {
            try {
                const response = await fetch(`${API_URL}/api/keys/${sessionId}`);
                if (response.ok) {
                    const data = await response.json();
                    updateKeyStatus(data.has_openai || data.has_anthropic, data);
                }
            } catch (e) {
                console.error('Failed to check API keys:', e);
            }
        }

        function updateKeyStatus(isSet, data = null) {
            apiKeysSet = isSet;
            const statusDiv = document.getElementById('keyStatus');
            const queryBtn = document.getElementById('queryBtn');

            if (isSet) {
                statusDiv.className = 'key-status set';
                let message = '‚úì API keys set';
                if (data) {
                    if (data.masked_openai) message += ` (OpenAI: ${data.masked_openai})`;
                    if (data.masked_anthropic) message += ` (Anthropic: ${data.masked_anthropic})`;
                }
                statusDiv.innerHTML = `<span>‚úì</span><span>${message}</span>`;
            } else {
                statusDiv.className = 'key-status not-set';
                statusDiv.innerHTML = '<span>‚ö†Ô∏è</span><span>No API keys set. Please add your keys below.</span>';
            }

            updateQueryButton();
        }

        function updateQueryButton() {
            const queryBtn = document.getElementById('queryBtn');
            queryBtn.disabled = !(apiKeysSet && uploadedFiles.length > 0);
        }

        // File upload handling
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        dropZone.addEventListener('click', () => fileInput.click());
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        async function handleFiles(files) {
            // Validate file sizes (100MB limit per file)
            const maxSize = 100 * 1024 * 1024;
            const validFiles = [];
            
            for (const file of files) {
                if (file.size > maxSize) {
                    showNotification(`${file.name} is too large (max 100MB)`, 'error');
                } else {
                    validFiles.push(file);
                }
            }
            
            if (validFiles.length === 0) {
                return;
            }
            
            const formData = new FormData();
            formData.append('session_id', sessionId);
            
            const totalSize = validFiles.reduce((sum, f) => sum + f.size, 0);
            for (const file of validFiles) {
                formData.append('files', file);
            }

            const startTime = Date.now();
            dropZone.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <div>
                        <div>Uploading ${validFiles.length} file(s) (${(totalSize / 1024 / 1024).toFixed(1)} MB)...</div>
                        <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 4px;">
                            Large PDFs may take 10-30 seconds to process
                        </div>
                    </div>
                </div>
            `;

            try {
                const response = await fetch(`${API_URL}/upload-multiple`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);

                if (data.success) {
                    uploadedFiles = [...uploadedFiles, ...data.documents];
                    updateFileList();
                    showNotification(`‚úì Uploaded ${data.documents.length} file(s) in ${elapsed}s`, 'success');
                } else {
                    showNotification(data.message || 'Upload failed', 'error');
                }
            } catch (error) {
                showNotification('Upload failed: ' + error.message, 'error');
            } finally {
                dropZone.innerHTML = `
                    <div class="icon-large">[UPLOAD]</div>
                    <p>Drag & drop files here or click to browse</p>
                    <div class="file-types">Supports: PDF, TXT, DOCX, MD, JSON, Code files (Max 100MB)</div>
                `;
            }
        }

        function updateFileList() {
            const fileList = document.getElementById('fileList');

            if (uploadedFiles.length === 0) {
                fileList.innerHTML = '';
                updateQueryButton();
                return;
            }

            fileList.innerHTML = uploadedFiles.map((file, index) => `
                <div class="file-item">
                    <div class="name">
                        <span>[${file.doc_type.toUpperCase()}]</span>
                        <span>${file.filename}</span>
                        <small style="color: var(--text-muted);">
                            (${(file.total_chars / 1000).toFixed(1)}K chars, ${file.num_chunks} chunks
                            ${file.processing_time_seconds ? `‚Ä¢ ${file.processing_time_seconds}s` : ''})
                        </small>
                    </div>
                    <button class="remove" onclick="removeFile(${index})">X</button>
                </div>
            `).join('');

            updateQueryButton();
        }

        async function removeFile(index) {
            uploadedFiles.splice(index, 1);
            updateFileList();
        }

        // Query handling
        async function submitQuery() {
            if (!apiKeysSet) {
                alert('Please set your API keys first');
                return;
            }

            const query = document.getElementById('queryInput').value.trim();
            if (!query) {
                alert('Please enter a question');
                return;
            }

            if (uploadedFiles.length === 0) {
                alert('Please upload at least one document');
                return;
            }

            const useSubcalls = document.getElementById('useSubcalls').checked;
            const maxIterations = parseInt(document.getElementById('maxIterations').value) || 50;

            const resultsDiv = document.getElementById('results');
            const resultsContent = document.getElementById('resultsContent');

            resultsDiv.classList.remove('hidden');
            resultsContent.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <span>Processing with RLM... This may take 30-60 seconds.</span>
                </div>
            `;

            try {
                const response = await fetch(`${API_URL}/query`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        query: query,
                        use_subcalls: useSubcalls,
                        max_iterations: maxIterations
                    })
                });

                const data = await response.json();

                if (data.success) {
                    resultsContent.innerHTML = `
                        <div class="answer">${escapeHtml(data.answer)}</div>
                        <div class="stats">
                            <div class="stat">
                                <div class="value">${data.iterations}</div>
                                <div class="label">Iterations</div>
                            </div>
                            <div class="stat">
                                <div class="value">${data.sub_lm_calls}</div>
                                <div class="label">Sub-LM Calls</div>
                            </div>
                            <div class="stat">
                                <div class="value">${data.processing_time_seconds}s</div>
                                <div class="label">Time</div>
                            </div>
                        </div>
                    `;
                } else {
                    resultsContent.innerHTML = `
                        <div class="error">
                            <strong>Error:</strong> ${escapeHtml(data.error || 'Unknown error')}
                            ${data.error && data.error.includes('API key') ? '<br><br>Please check your API keys and try again.' : ''}
                        </div>
                    `;
                }
            } catch (error) {
                resultsContent.innerHTML = `
                    <div class="error">
                        <strong>Error:</strong> ${escapeHtml(error.message)}
                    </div>
                `;
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/\n/g, '<br>');
        }

        function showNotification(message, type) {
            // Simple notification - could be enhanced
            console.log(`[${type}] ${message}`);
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', initSession);
    </script>
</body>
</html>
